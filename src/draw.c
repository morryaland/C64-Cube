#include <string.h>
#include "draw.h"

#define _ BITMAP_ADDR
/* i in 0..199 */
/* 0x20 + ((i & 0xF8) * 40) + (i & 7) */
const unsigned int ylookup[] = {
_+32,_+33,_+34,_+35,_+36,_+37,_+38,_+39,_+352,_+353,_+354,_+355,_+356,_+357,_+358,_+359,_+672,_+673,_+674,_+675,_+676,_+677,_+678,_+679,_+992,_+993,_+994,_+995,_+996,_+997,_+998,_+999,_+1312,_+1313,_+1314,_+1315,_+1316,_+1317,_+1318,_+1319,_+1632,_+1633,_+1634,_+1635,_+1636,_+1637,_+1638,_+1639,_+1952,_+1953,_+1954,_+1955,_+1956,_+1957,_+1958,_+1959,_+2272,_+2273,_+2274,_+2275,_+2276,_+2277,_+2278,_+2279,_+2592,_+2593,_+2594,_+2595,_+2596,_+2597,_+2598,_+2599,_+2912,_+2913,_+2914,_+2915,_+2916,_+2917,_+2918,_+2919,_+3232,_+3233,_+3234,_+3235,_+3236,_+3237,_+3238,_+3239,_+3552,_+3553,_+3554,_+3555,_+3556,_+3557,_+3558,_+3559,_+3872,_+3873,_+3874,_+3875,_+3876,_+3877,_+3878,_+3879,_+4192,_+4193,_+4194,_+4195,_+4196,_+4197,_+4198,_+4199,_+4512,_+4513,_+4514,_+4515,_+4516,_+4517,_+4518,_+4519,_+4832,_+4833,_+4834,_+4835,_+4836,_+4837,_+4838,_+4839,_+5152,_+5153,_+5154,_+5155,_+5156,_+5157,_+5158,_+5159,_+5472,_+5473,_+5474,_+5475,_+5476,_+5477,_+5478,_+5479,_+5792,_+5793,_+5794,_+5795,_+5796,_+5797,_+5798,_+5799,_+6112,_+6113,_+6114,_+6115,_+6116,_+6117,_+6118,_+6119,_+6432,_+6433,_+6434,_+6435,_+6436,_+6437,_+6438,_+6439,_+6752,_+6753,_+6754,_+6755,_+6756,_+6757,_+6758,_+6759,_+7072,_+7073,_+7074,_+7075,_+7076,_+7077,_+7078,_+7079,_+7392,_+7393,_+7394,_+7395,_+7396,_+7397,_+7398,_+7399,_+7712,_+7713,_+7714,_+7715,_+7716,_+7717,_+7718,_+7719,
};
#undef _

#if !LINE_MODE
__zp char curcolor;
__zp char xbitf[] = {
  0b10011001,
  0b01100110,
  0b00011001,
  0b00100110,
  0b00001001,
  0b00000110,
  0b00000001,
  0b00000010,
};
__zp char xbitl[] = {
  0b10000000,
  0b01000000,
  0b10010000,
  0b01100000,
  0b10011000,
  0b01100100,
  0b10011001,
  0b01100110,
};
#endif

#if LINE_MODE
__zp char xbit[] = {
  0b10000000,
  0b01000000,
  0b00100000,
  0b00010000,
  0b00001000,
  0b00000100,
  0b00000010,
  0b00000001
};

void plot(char x, char y)
{
  ((char*)ylookup[y])[x & ~7] |= xbit[x & 7];
}

void line(char x1, char y1, char x2, char y2)
{
  char dx, dy;
  signed char xi, yi;
  int d, ai, bi;
  if (x1 < x2) {
    xi = 1;
    dx = x2 - x1;
  }
  else {
    xi = -1;
    dx = x1 - x2;
  }
  if (y1 < y2) {
    yi = 1;
    dy = y2 - y1;
  }
  else {
    yi = -1;
    dy = y1 - y2;
  }
  if (dx > dy) {
    ai = (dy - dx) * 2;
    bi = dy * 2;
    d = bi - dx;
    while (x1 != x2) {
      if (d > 0) {
        y1 += yi;
        d += ai;
      }
      else
        d += bi;
      x1 += xi;
      plot(x1, y1);
    }
  }
  else {
    ai = (dx - dy) * 2;
    bi = dx * 2;
    d = bi - dy;
    while (y1 != y2) {
      if (d > 0) {
        x1 += xi;
        d += ai;
      }
      else
        d += bi;
      y1 += yi;
      plot(x1, y1);
    }
  }
}
#else
void hline(char xl, char y, char xr) {
  char tmp;
  if (xl > xr) {
    tmp = xl;
    xl = xr;
    xr = tmp;
  }
  char *addr = (char*)ylookup[y];
  char fbit = xbitf[(xl&6)+(y%2)];
  char lbit = xbitl[(xr&6)+(y%2)];
  xl &= ~7;
  xr &= ~7;
  if (xl == xr) {
    addr[xl] |= fbit & lbit;
    return;
  }
  addr[xl] |= fbit;
  addr[xr] |= lbit;
  xl += 8;
  while (xl < xr) {
    addr[xl] = xbitf[y%2];
    xl += 8;
  }
}

void triangle(char x1, char y1, char x2, char y2, char x3, char y3)
{
  char dx, dx2, dx3, dy, dy2, dy3, tmp;
  signed char xi, xi2, xi3;
  int d, d2;
  /* swap */
  if (y2 < y1) {
    tmp = y2;
    y2 = y1;
    y1 = tmp;
    tmp = x2;
    x2 = x1;
    x1 = tmp;
  }
  if (y3 < y1) {
    tmp = y3;
    y3 = y1;
    y1 = tmp;
    tmp = x3;
    x3 = x1;
    x1 = tmp;
  }
  if (y3 < y2) {
    tmp = y3;
    y3 = y2;
    y2 = tmp;
    tmp = x3;
    x3 = x2;
    x2 = tmp;
  }
  /* delta calc */
  dy = y2 - y1;
  dy2 = y3 - y1;
  dy3 = y3 - y2;
  if (x1 < x2) {
    xi = 1;
    dx = x2 - x1;
  }
  else {
    xi = -1;
    dx = x1 - x2;
  }
  if (x1 < x3) {
    xi2 = 1;
    dx2 = x3 - x1;
  }
  else {
    xi2 = -1;
    dx2 = x1 - x3;
  }
  if (x2 < x3) {
    xi3 = 1;
    dx3 = x3 - x2;
  }
  else {
    xi3 = -1;
    dx3 = x2 - x3;
  }
  d = dy - dx;
  d2 = dy2 - dx2;
  tmp = x1;
  while (y1 != y2) {
    while (d < 0) {
      x1 += xi;
      d += dy * 2;
    }
    while (d2 < 0) {
      tmp += xi2;
      d2 += dy2 * 2;
    }
    d -= dx * 2;
    d2 -= dx2 * 2;
    y1++;
    /* draw line */
    hline(tmp, y1, x1);
  }
  d = dy3 - dx3;
  while (y1 != y3) {
    while (d < 0) {
      x2 += xi3;
      d += dy3 * 2;
    }
    while (d2 < 0) {
      tmp += xi2;
      d2 += dy2 * 2;
    }
    d -= dx3 * 2;
    d2 -= dx2 * 2;
    y1++;
    /* draw line */
    hline(tmp, y1, x2);
  }
}
#endif
